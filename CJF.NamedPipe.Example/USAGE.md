# CJF.NamedPipe.Example 使用說明

## 概述

這個示例專案展示了如何使用重構後的 CJF.NamedPipe 庫來建立命名管道服務器和客戶端。

## 修復說明

已修復了服務器端在處理連接測試時的 `EndOfStreamException` 錯誤。現在服務器能夠正確處理：
- 連接測試（客戶端快速連接後斷開）
- 不完整的數據讀取
- 管道連接中斷

## 運行方式

### 1. 啟動服務器

在第一個終端中運行：

```bash
cd CJF.NamedPipe.Example
dotnet run
```

您會看到類似以下的輸出：
```
CJF.NamedPipe 示例應用程序
==========================
啟動命名管道服務器...
服務器已啟動，按 Ctrl+C 停止服務器
您可以在另一個終端中運行 'dotnet run client' 來測試客戶端
```

### 2. 啟動客戶端

在第二個終端中運行：

```bash
cd CJF.NamedPipe.Example
dotnet run -- client
```

您會看到類似以下的輸出：
```
CJF.NamedPipe 示例應用程序
==========================
啟動命名管道客戶端...
等待服務器啟動...
已連接到服務器！

選擇操作:
1. 發送一般命令
2. 發送串流命令
3. 測試連接
4. 退出
請輸入選項 (1-4):
```

## 功能測試

### 測試一般命令

選擇選項 `1`，然後嘗試以下命令：

- `hello` - 返回 "Hello, World!"
- `time` - 返回當前時間
- `echo` - 回音輸入的參數
- `add 5 3` - 計算 5 + 3
- `error` - 測試錯誤處理

### 測試串流命令

選擇選項 `2`，然後嘗試以下命令：

- `countdown 5` - 5秒倒數
- `progress 10` - 顯示進度條（10步）
- `error-test` - 測試串流錯誤處理
- 任何其他命令 - 顯示預設的3步處理過程

### 測試連接

選擇選項 `3` 來測試連接狀態。

## 預期行為

### 服務器端

- 服務器啟動時會顯示啟動訊息
- 處理客戶端請求時會顯示收到的命令和參數
- 連接測試不會產生錯誤訊息（已修復）
- 使用 Ctrl+C 停止服務器

### 客戶端端

- 客戶端會等待服務器啟動
- 成功連接後顯示操作選單
- 一般命令會立即返回結果
- 串流命令會即時顯示進度訊息
- 不同類型的訊息會以不同顏色顯示

## 配置

服務器配置在 `appsettings.json` 中：

```json
{
  "PipeLine": {
    "CommandPipeName": "CJF.Example.Command.Pipe",
    "StreamPipeName": "CJF.Example.Stream.Pipe",
    "MaxClients": 10,
    "ConnectionTimeoutMs": 5000,
    "ReadWriteTimeoutMs": 5000
  }
}
```

## 故障排除

### 常見問題

1. **客戶端無法連接**
   - 確保服務器已啟動
   - 檢查管道名稱是否一致

2. **權限錯誤**
   - 在某些系統上可能需要管理員權限

3. **端口衝突**
   - 命名管道不使用網路端口，但確保管道名稱唯一

### 日誌記錄

服務器會輸出詳細的日誌訊息，包括：
- 服務啟動/停止
- 客戶端連接
- 命令處理
- 錯誤訊息

## 開發說明

這個示例展示了：
- ASP.NET Core DI 模式的使用
- 配置選項的綁定
- 命令和串流處理器的實作
- 錯誤處理和日誌記錄
- 客戶端和服務器的生命週期管理

## 修復詳情

修復了以下問題：
- `EndOfStreamException` 當客戶端進行連接測試時
- 改進了錯誤處理，區分正常斷線和異常錯誤
- 增加了數據長度驗證
- 改善了日誌記錄的詳細程度
